 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 100px;
        }
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #0078d4;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn:hover {
            background-color: #005fa3;
        }

        
        .nav-btn {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 16px;
            background-color: #f3f3f3;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .nav-btn:hover {
            background-color: #0078d4;
            color: #fff;
        }
        body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin-top: 100px;
}

.btn {
    padding: 15px 30px;
    font-size: 18px;
    background-color: #0078d4;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
}

.btn:hover {
    background-color: #005fa3;
}
    </style>
</head>
<body>
    <h1>Account Registration</h1>
    <form id="registrationForm">
        <label for="username">Username:</label><br>
        <input type="text" id="username" name="username" required><br><br>
        <label for="password">Password:</label><br>
        <input type="password" id="password" name="password" required><br><br>
        <label for="confirmPassword">Retype Password:</label><br>
        <input type="password" id="confirmPassword" name="confirmPassword" required><br><br>
        <label for="profilePic">Profile Picture:</label><br>
        <input type="file" id="profilePic" name="profilePic" accept="image/*"><br><br>
        <button class="btn" type="submit">Register</button>
        <button class="btn" onclick="location.href='../index.html'; return false;">Back to Home</button>
    </form>
    <div id="message"></div> <!-- For success/error messages -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Initialize Dexie DB with profilePic field
        const db = new Dexie("UserDatabase");
        db.version(1).stores({
            users: "++id,username,passwordHash,profilePic"
        });

        document.getElementById('registrationForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const profilePicInput = document.getElementById('profilePic');
            const messageDiv = document.getElementById('message');

            // Hash both passwords using SHA-256
            const passwordHash = CryptoJS.SHA256(password).toString();
            const confirmPasswordHash = CryptoJS.SHA256(confirmPassword).toString();

            // Check if both hashes match
            if (passwordHash !== confirmPasswordHash) {
                messageDiv.textContent = "Passwords do not match.";
                messageDiv.style.color = 'red';
                return;
            }

            // Read profile picture as base64 (if provided)
            let profilePicData = "";
            if (profilePicInput.files && profilePicInput.files[0]) {
                const file = profilePicInput.files[0];
                profilePicData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            try {
                // Check if username already exists
                const existingUser = await db.users.where('username').equals(username).first();
                if (existingUser) {
                    messageDiv.textContent = "Username already taken. Please choose another.";
                    messageDiv.style.color = 'red';
                    return;
                }

                // Add new user to the database
                await db.users.add({ username, passwordHash, profilePic: profilePicData });
                messageDiv.textContent = "Registration successful! Redirecting to dashboard...";
                messageDiv.style.color = 'green';
                // Store username and profilePic in sessionStorage so dashboard and account pages can use them
                try {
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('profilePic', profilePicData || '');
                } catch (e) {
                    // ignore storage errors
                }
                document.getElementById('registrationForm').reset();
                // Redirect immediately to dashboard
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error("Error during registration:", error);
                messageDiv.textContent = "An error occurred. Please try again.";
                messageDiv.style.color = 'red';
            }
        });
    </script>
</body>
</html>